generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String    @id @default(cuid())
  name             String?
  email            String    @unique
  password         String?
  role             Role      @default(STAFF)
  invitationToken  String?   @unique
  resetToken       String?   @unique
  resetTokenExpiry DateTime?
  failedAttempts   Int       @default(0)
  lockedUntil      DateTime?

  testsCreated       Test[]
  testsUpdated       Test[]     @relation("TestUpdates")
  auditLogs          AuditLog[]
  patientsRegistered Patient[]
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  event     String
  details   String
  createdAt DateTime @default(now())
}

model Patient {
  id            String   @id @default(cuid())
  firstName     String
  lastName      String
  dateOfBirth   DateTime
  email         String?
  phone         String?
  consentForm   String?
  qrCode        String
  createdBy     String
  createdByUser User     @relation(fields: [createdBy], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  tests         Test[]
}

model Test {
  id             String     @id @default(cuid())
  patientId      String
  patient        Patient    @relation(fields: [patientId], references: [id])
  status         TestStatus
  collectionDate DateTime
  receivedDate   DateTime?
  processedDate  DateTime?
  resultDate     DateTime?
  result         String?
  notes          String?
  createdBy      String
  createdByUser  User       @relation(fields: [createdBy], references: [id])
  updatedBy      String?
  updatedByUser  User?      @relation("TestUpdates", fields: [updatedBy], references: [id])
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

enum TestStatus {
  ISSUED
  COLLECTED
  RECEIVED
  IN_PROGRESS
  COMPLETED
  COMMUNICATED
}

enum Role {
  ADMIN
  STAFF
  LAB_TECHNICIAN
  CALL_CENTER_AGENT
}
